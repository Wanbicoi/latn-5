mediflow.freemyip.com {
  # Enable gzip compression
  encode gzip

  # OHIF3 proxy
  handle_path /ohif3/* {
    reverse_proxy https://latn-3-ohif3.pages.dev {
      # No buffering
      flush_interval -1
      # SSL server name indication
      header_up Host latn-3-ohif3.pages.dev
    }
  }

  # Datasource/Orthanc proxy
  handle_path /datasource/* {
    reverse_proxy http://orthanc:8042 {
      # No buffering
      flush_interval -1
      # Headers
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      
      # Timeouts
      transport http {
        read_timeout 300s
        write_timeout 300s
        dial_timeout 30s
      }
    }

    # Response headers
    header {
      Cache-Control private
      Expires 0
      Access-Control-Allow-Origin *
      defer
    }

    # Handle OPTIONS preflight requests
    @options method OPTIONS
    handle @options {
      header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
        Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With"
        Access-Control-Max-Age 1728000
        Content-Length 0
        Content-Type "text/plain; charset=UTF-8"
      }
      respond 204
    }
  }

  # Default location (root)
  handle {
    reverse_proxy https://latn-5.pages.dev {
      # No buffering
      flush_interval -1
      # SSL server name indication
      header_up Host latn-5.pages.dev
    }
  }
}
