mediflow.freemyip.com {
  encode gzip

  # HTTP to HTTPS redirect
  @http {
    protocol http
  }
  redir @http https://{host}{uri}

  # Datasource/Orthanc proxy (match both /datasource and /datasource/*)
  @datasource path /datasource /datasource/*
  reverse_proxy @datasource http://orthanc:8042 {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
    header_up Connection {>Connection}
    header_up Upgrade {>Upgrade}
  }

  # OHIF viewer proxy (match both /ohif3 and /ohif3/*)
  @ohif path /ohif3 /ohif3/*
  reverse_proxy @ohif https://latn-3-ohif3.pages.dev {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
  }

  # Default proxy
  reverse_proxy https://latn-5.pages.dev {
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
  }

  # Global headers
  header {
    Access-Control-Allow-Origin *
    Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
    Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With"
    Access-Control-Max-Age 1728000

    X-Content-Type-Options nosniff
    X-Frame-Options DENY
    X-XSS-Protection "1; mode=block"

    Cache-Control "private, no-cache"
    Expires 0
  }
}